name: 05. Variables + Secrets + Slack Webhook (push)

# 목적
# - GitHub Actions "Variables"(vars)와 "Secrets"(secrets)를 실습합니다.
# - push 발생 시, 변수로 받은 메시지를 echo 하고,
#   Secret으로 받은 Slack Incoming Webhook URL로 Slack 액션을 통해 메시지를 전송합니다.
#
# 준비(저장소에서 설정해야 함)
# 1) Repository Variable 추가
#   - GitHub 저장소 → Settings → Secrets and variables → Actions → Variables
#   - Name: SLACK_MESSAGE
#   - Value: 예) "main에 push 되었습니다!"
#
# 2) Repository Secret 추가
#   - GitHub 저장소 → Settings → Secrets and variables → Actions → Secrets
#   - Name: SLACK_WEBHOOK_URL
#   - Value: Slack Incoming Webhook URL (https://hooks.slack.com/services/...)
#
# Variables vs Secrets
# - vars: 암호화되지 않음(값이 노출될 수 있음). "민감하지 않은 설정"에만 사용.
# - secrets: 암호화/마스킹됨. 토큰/웹훅 URL 등 민감정보에 사용.
#
# 주의
# - 이 워크플로는 push에서만 실행되므로, secrets가 제한되는 fork PR 케이스는 다루지 않습니다.
# - 잘못된 Webhook URL을 넣으면 Slack 전송이 실패합니다(HTTP 4xx/5xx).

on:
  push:
    branches:
      - "**"

jobs:
  notify:
    runs-on: ubuntu-latest

    # 이 워크플로는 외부(Slack)로 HTTP 요청만 보내므로 GitHub API 권한이 필요 없습니다.
    permissions:
      contents: read

    # env로 값을 내려 "step"에서 동일하게 사용합니다.
    # - vars.*: 저장소 Variables
    # - secrets.*: 저장소 Secrets (이 예제에서는 Slack action 입력으로 직접 전달)
    env:
      MESSAGE_FROM_VARIABLE: ${{ vars.SLACK_MESSAGE }}

    steps:
      - name: 실행 컨텍스트 출력(디버깅용)
        run: |
          echo "이벤트: ${{ github.event_name }}"
          echo "브랜치: ${{ github.ref_name }}"
          echo "커밋: ${{ github.sha }}"
          echo "실행자: ${{ github.actor }}"

      - name: 변수 메시지 echo
        # vars 로 받은 메시지는 민감정보가 아니어야 합니다.
        run: |
          echo "Variables(SLACK_MESSAGE)로 받은 메시지: ${MESSAGE_FROM_VARIABLE:-}"

      - name: Slack Webhook 전송 (Action)
        # slackapi/slack-github-action 사용: Incoming Webhook URL을 받아 메시지를 전송합니다.
        # secrets는 로그에 노출되지 않도록 직접 echo 하지 않습니다.
        # Secret이 비어있으면 step을 건너뜁니다.
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          # Incoming Webhook URL (Repository Secret)
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook

          # Slack에 보낼 payload (YAML)
          # - text는 가장 단순한 메시지 포맷입니다.
          # - vars 값이 비어있을 수 있으니 기본값을 함께 둡니다.
          payload: |
            text: |
              *${{ env.MESSAGE_FROM_VARIABLE || 'push 이벤트가 발생했습니다' }}*
              - repo: ${{ github.repository }}
              - branch: ${{ github.ref_name }}
              - actor: ${{ github.actor }}
              - sha: ${{ github.sha }}

      - name: Slack Webhook 미설정 안내
        if: ${{ secrets.SLACK_WEBHOOK_URL == '' }}
        run: |
          echo "SLACK_WEBHOOK_URL secret이 설정되어 있지 않아 전송을 건너뜁니다."
          echo "(Settings → Secrets and variables → Actions → Secrets)"
